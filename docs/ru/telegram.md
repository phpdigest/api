# Интеграция с Telegram

## Описание:

Интеграция с Telegram происходит следующим образом:

1. Пользователь пишет сообщение боту.
2. Бот отправляет `callback` (POST-запрос) на API.
3. Сервер обрабатывает входящий запрос:
    1. Обработка запроса по правилам бизнес-логики
    2. Взаимодействие с пользователем с помощью бота в обратную сторону

Пункты с п. 1 по п. 3 повторяются, пока пользователь пишет сообщение боту.

## Настройка

### Шаг 1. Подготовка окружения

1. [Создать бота](https://core.telegram.org/bots#creating-a-new-bot)
2. Сохранить токен в [config/params-local.php](../../config/params-local.php)
   ```php
   return [
       'telegram-bot' => [
           'token' => '{YOUR TOKEN HERE}',
       ],
   ];
   ```
3. [Зарегистрироваться](https://dashboard.ngrok.com/signup) на https://ngrok.com/
   и [скачать его](https://ngrok.com/download)

### Шаг 2. Настройка окружения

1. Запустить сервер: `docker-composer up -d`.
2. Запустить ngrok: `ngrok http 8080`, скопировать полученный **https-адрес** (***Telegram не работает с
   http-адресами***).
3. Связать бота с доменом из ngrok: `./vendor/bin/yii telegram/set-webhook {address}/telegram`

### Шаг 3. Работа с ботом

1. Написать боту `/start`. Бот должен прислать приветственное сообщение.
2. Написать боту `/suggest_link`. Бот должен начать диалог и спросить ссылку и описание.

## Полезная информация

* Логи ngrok: http://127.0.0.1:4040/inspect/http

## Решение проблем

* Если на 3-м шаге возникли проблемы, то стоит посмотреть в логах ngrok, идут ли запросы на выделенный домен.
* Ошибки можно найти как в логах ngrok, так и в логах в папке [var/logs](../../runtime/var/logs).
